 \input ctustyle
 \input glosdata
 \input opmac-bib
 \worktype [B/CZ]
 \faculty {F3}
 \department {Katedra řídicí techniky}
 \title {Řízení bezkartáčových motorů s deskou Raspberry Pi a Linuxem}
 \author {Martin Prudek}
 \date {Duben 2015}
 \abstractEN {Testing}
 \abstractCZ {Testovani}
 \declaration {Prohlasuji, ze jsem pracoval poctive.}
 \makefront
 
 \def\frac#1#2{{\begingroup#1\endgroup\over#2}} %/frac je LaTex, definujme vlastni

 \chap Úvod
 
  S přechodem od analogových regulačních obvodů ke stále rozvinutějším digitalním řidicím zařízením je možné využít automatizaci i tam, kde to dříve nebylo možné. Je to patrné například na stále běžnějším využití ruzných dronů či multikoptér. Zařízení dříve považovaná za přísně střežená vojenská tajemství se dnes, jako už mnohokrát v dějinách, stávají běžnou součástí našich domácností. 
  
  Vývoj se však nepohybuje jen ve směru zdokonalování technologií, neboť v mnoha situacích je rozhodujícím faktorem cena. Návrhář řídicího systému se musí v hojných případech rozhodovat mezi dvěma variantami. Buď použít často velmi levný analogový řídicí obvod, který je ale úzce specializovaný a při úpravě parametrů se jeho modifikace dále velmi prodražují. Nebo řídicí počítač, který při změně problému stačí mnohdy jen přeprogramovat. Na trh se tak dostává mnoho velmi levných zařízení, z nichž některá jsou myšlena spíše jako hračky či výúkové nástroje. Přesto může být zajímavé takové zařízení otestovat a použít k vážněji myšlenému řízení. Z široké nabídky takových zařízení, jako jsou BeagleBone, Raspberry Pi či Banana Pi  
 \fnote{Root.cz, Srovnání: Raspberry Pi a jeho největší konkurenti \url{http://www.root.cz/clanky/srovnani-raspberry-pi-a-jeho-nejvetsi-konkurenti/}} 
 jsme vybrali pro tuto práci Raspberry PI model B rev. 2.0. 
 
 {\bf Raspberry Pi} (dále jen Rpi) je počítač realizovaný na jednom plošném spoji, velikosti kreditní karty, který od roku 2006 vyvíjí britská nadace {\em Raspberry Pi Foundation} \fnote{web Raspberry Pi Foundation\url{https://www.raspberrypi.org/}}. Výhodou je možnost využití univerzálního operačního systému, například výrobcem poskytovaného Raspbianu. Jako na Linuxovou distribuci je pak možné na tento systém aplikovat Real-Time vylepšení, které zajistí splnění časových omezení vyžadovaných řízením. Více k Rpi a RT vylepšení Linuxu uvedu v sekci \ref[sec_rpi] a \ref[sec_rt].
 
 U tohoto počítače již byla prostudována možnost řízení stejnosměrného motoru s využitím zachytávání impulzů inkrementálního rotačního senzoru polohy \cite[Meciar]. Stejně tak jako u podobných levných zařízení i zde však naražíme na hranice, které nám nevýkonný hardware nedovoluje překonat. U \glref{RPi} tak docházelo ke kritickým časovým prodlevám při zpracovávání přijatých pulsů. Takové chování nastávalo již od frekvence pulsů 14kHz, což při 500 pulsech na jednu otočku dělá 2100ot/min.
 
 Výdodným řeším tohoto problému se stává přesunutí zpracování pulsů \glref{IRC} do speciálního obvodu a zjištěnou polohu motoru posílat jako celek. Rpi tedy zpracovává jen jednu řídicí smyčku o neměnné frekvenci, z hlediska výpočetního výkonu tedy již otáčky motoru nehrají roli. Pro tuto práci se tímto obvodem stala deska s \glref{FPGA} obvodem , vyvinutá firmou {\em PiKRON} \fnote{PiKRON \url{http://www.pikron.com/}}. Podrobnosti v sekci \ref[sec_fpga].
 
 Pro komunikaci s FPGA obvodem bylo třeba vybrat jednoduchý komunikační protokol. Požadavkem byla možnost obousměrné komunikace a současně vzhledem k frekvenci řídicí smyčky a objemu přenesených dat dostatečná rychlost. Bylo také nutné, aby použitý protokol byl natolik nekomplikovaný, že půjde výhodně realizovat v FPGA obvodu a na straně druhé pohodlně zpracovat v jádře operačního systému na RPi. 
 
 Jak jsem již zmínil, překotný vývoj digitálních řidicích zařizení hlavně koncem druhé poloviny 20. století nábídl možnosti jejich využití i tam, kde to dříve nebylo možné. Dalším důležitým milníkem je i pokrok v bezstrátovém řízení výkonu a využití nových výkonových spínacích prvků. Přikladem nechť je vývoj synchronního bezkartáčového motoru s permanentním magnetem v rotoru (dále PMS motory či jen PMSM). Bez digitálního zpracování dat a PWM modulace by jeho provoz nebyl možný. Takový motor přitom nabízí ve srovnáním s konvenčním indukčním(asynchronním) motorem hned několik výhod. Nejdůležitějšími jsou plynulé řízení polohy, rychlosti a točivého momentu. Oproti kartáčovému DC motoru pak odpadá použití kartáčů, kolísání točivého momentu a zvvyšuje se efektivita. Více o PMS motorech uvedu v kapitole \ref[chap_pmsm].

 
 \label[chap_pmsm]
 \chap PMS motory

PMS (Permanent Magnet Synchronous) motory jsou díky vysoké efektivitě a robustní kontrukci bez kartáčů vhodnou volbou v mnoha řídicích aplikacích\cite[ESD]. 

Komutace probíhá na rozdíl od kartáčových motorů elektronicky, což přínáší vyšší požadavky na řídicí hardware. Ve chvíli, kdy dnes většina aplikací vyžaduje elektronické řízení jak rychlosti, tak točivého momentu, nepředstavuje ale řídicí elektronika zátěž navíc. \cite[sensorless]. Odměnou je naopak výšší výkon v poměru k váze, stejně tak točivý moment v poměru k příkonu. Výhodou jsou také nížší hlučnost a delší životnost, protože nedochází k opotřebení kartáčů a mechanických částí komutátoru. \cite[PMSM-Kinetis] Elektronická komutace bývá implementována v procesorovém systému, či speciálním obvodu (FPGA / ASIC)\cite[Meloun].
 
 3-fázové synchronní motory s permanentním magnetem se často využívají kromě PMS varianty se sinusovým průběhem \glref{BEMF} také v \glref{BLDC} variantě s lichoběžníkovým (trapezoidal) průběhem BEMF. Přičemž výhodou PMSM je konstatní točivý moment v celém rozsahu otáčení, zatímco BLCD motor je snadněji řiditelný a dnes se využívá převážně z historických  důvodů. \cite[sensorless]
 \sec Konstrukce
 
 Základ konstrukce PMS Motoru je postaven na konstrukci 3-fázového indukčního (asynchronního) motoru.
 
 Statorem prochází vinutí jednotlivých fází. Počet vinutí pak závisí na počtu pólů permanentního magnetu umístěného ve statoru. Obvyklá varianta jsou dva páry pólů (polpáry) permanentního magnetu, viz Obrázek \ref[pole_pairs]. Celý návrh je přitom optimalizován pro buzení sinusovým průběhem, stejně tak zpětné  elktromotorické napětí vykazuje sinusový průběh. \cite[ijetae] \cite[ti_pmsm].
 
\medskip \clabel[pole_pairs]{PMS Motor se dvěma pólovými dvojicemi}
\picw=8cm \cinspic PMSM.png
\caption/f PMS Motor se dvěma pólovými dvojicemi
\medskip 


 \sec Matematický popis
 
 Uvažujme $i_{sa}$, $i_{sb}$ a $i_{sc}$ proudy procházející vinutím statoru, platí:
 
 $$ i_{sa} + i_{sb} + i_{sc} =0\eqmark $$
 
 Toto může být vyjádřeno jako vektor v komplexní rovině, potom:
 
 $$ \overline{i} = k(i_{sa}+ai_{sb}+a^2i_{sc}) \eqmark$$
 kde $a$ a $a^2$ jsou operátory posouvajíci fázi o 120°, $ a=e^{{2j\pi}/{3}} $ a $a^2=e^{{4j\pi}/{3}}$.
 $k$ je transformační konstanta.
 
 $\overline{i}$ můžeme vyjádřit jako součet jeho reálné a imaginární složky:

 $$ \overline{i}=i_{s\alpha}+ji_{s\beta} \eqmark$$
 
\medskip \clabel[proudy]{Komplexní vyjádření vektoru proudu vinutím statoru}
\picw=7cm \cinspic currents.png
\caption/f Komplexní vyjádření vektoru proudu vinutím statoru. $\alpha$ značí reálnou osu a $\beta$ značí imaginární osu.
\medskip %obrazek zustal tam, kde ma. \midinsert ho posunul

Se znalostí proudů, protékajících jednotlivými fázemi, pak můžeme vypočítat myšlené proudy tekoucí rovnoběžně s imaginární a reálnou osou.

 $$ 
 \eqalignno{ i_{s\alpha}&=k(i_{sa}-i_{sb}/2-i_{sc}/2) \cr
  i_{s\alpha}&=(2i_{sa}-i_{sb}-i_{sc})/3 & \eqmark \cr}
  $$
 
$$
\eqalignno{ i_{s\beta}&=k\sqrt{3}(i_{sb}-i_{sc})/2 \cr
	i_{s\beta}&=(i_{sb}-i_{sc})/\sqrt{3}  & \eqmark \cr}
$$

Pro volbu $k=2/3$.

Pro popis PMS motorů je uvažován ideálně symetrický motor se sinusoidně rozloženým vinutím. Pro takovou idealizaci uvažujeme napětí na vinutích $u_{sa}$, $u_{sb}$ a $u_{sc}$  následující:

$$
\label[rce1]
u_{sa}=R_si_{sa}+{{d}\over{dt}}\psi_{sa} \eqmark$$
$$ u_{sb}=R_si_{sb}+{{d}\over{dt}}\psi_{sb} \eqmark$$
$$ u_{sc}=R_si_{sc}+{{d}\over{dt}}\psi_{sc} \eqmark$$

kde $\psi_{sa}$,$\psi_{sb}$ a $\psi_{sc}$ jsou magnetické indukční toky vyvolané proudy odpovídajících vinutí. Vyjádření napětí vektorem v Gaussově(komplexní) rovině (Clarkova transformace, $\alpha\beta$ transformace) bude následující:

 $$ u_{s\alpha}=R_si_{s\alpha}+{{d}\over{dt}}\psi_{s\alpha} \eqmark$$
 $$ u_{s\beta}=R_si_{s\beta}+{{d}\over{dt}}\psi_{s\beta} \eqmark$$
 
 Přitom složky magnetického indukčního toku budou následující:
 
 $$\psi_{s\alpha} = L_{s\alpha}i_{s\alpha} + \psi_Mcos\theta_r \eqmark$$
 $$\psi_{s\beta} = L_{s\beta}i_{s\beta} + \psi_Msin\theta_r \eqmark$$
 
 kde $\theta_r$ je úhlová pozice rotoru a $\psi_M$ je magnetický indukční tok rotoru. $L_{s\alpha}$ a $L_{s\beta}$ jsou složky vzájemné indukčnosti rotor-stator.  

Úhlové zrychlení takového motoru o zátěži $T_L$ s $p$ póly připadajícími na každou fázi můžeme vyjádřit jako:

$$
\label[rce2]
{d\omega\over{dt}}=
{p\over{j}}\lbrack{3\over{2}}p(\psi_{s\alpha}i_{s\beta}-\psi_{s\beta}i_{s\alpha})-T_L\rbrack
\eqmark
$$

Rovnice \ref[rce1] az \ref[rce2] představují model PMS motoru v souřadné soustavě ($\alpha, \beta$) spojené se statorem.


Kromě soustavy spojené se statorem bývá někdy výhodné vyjádřit tyto večiny v soustavě spojené s rotorem.
Jak bude dále vysvětleno, je totiž výhodné, aby vektor megnetické indukce, magnetického pole vyvolávaného proudy protékající vinutím statoru, svíral pravý úhel s vektorem mg. indukce mg. pole permanentního magnetu rotoru. Pro tyto účely je tedy vhodné veličiny fixovat právě k souřadné soustavě rotoru. 

Pro statickou soustavu jsme úspěchem využili Clarkovu trnsformaci, nyní, pro rotující vztažnou soustavu použijeme Parkovu (dq0) transformaci.

Pro genralizovanou rotující soustavu bude transformace vypadat následovně (viz Obrázek \ref[park]):

$$ \overline{i_{sg}}=\overline{i_s}e^{-j\theta_g} \eqmark$$

\medskip \clabel[park]{Parkova transformace}
\picw=8cm \cinspic StatorCurrents.png
\caption/f Parkova transformace 
\medskip 

A pro soustavu spojenou s rotorem již můžeme dosadit:

$$u_{sd}=R_si_{sd}+{d\over{dt}}\psi_{sd}-\omega_r\psi_{sq} \eqmark $$
$$u_{sq}=R_si_{sq}+{d\over{dt}}\psi_{sq}-\omega_r\psi_{sd} \eqmark $$

kde $\psi$ jsou odpovídající mg. indukční toky a $\omega_r$ je úhlová rychlost rotoru.

 $$\psi_{sd} = L_{sd}i_{sd} + \psi_M \eqmark$$
 $$\psi_{sq} = L_{sq}i_{sq} \eqmark$$
 
Úhlové zrychlení: 
 
$$
\label[rce3]
{d\omega\over{dt}}=
{p\over{j}}\lbrack{3\over{2}}p(\psi_{sd}i_{sd}-\psi_{sq}i_{sq})-T_L\rbrack
\eqmark
$$

 \midinsert \clabel[dq0]{Poloha os Parkovy transformace}
\picw=8cm \cinspic dq0.png
\caption/f Osy d(direct) a q(quadrature) jsou voleny vzhledem k rotoru.
\endinsert 

 \sec Řízení
 
 PMS Motory se vyznačují plynulou rychlostí v celém rozsahu rotace a schopností plně řídit točivý moment i při nulové rychlosti. K tomu se využívaji techniky vektorového řízení. Ty rozloží proud protékající vinutím statoru na složky generující magnetické pole a točivý moment. Tyto složky pak můžeme řídit na sobě nezávisle a přiblížit se tak řízení obyčeného kartáčového DC motoru \cite[PMSMC]. Metematickým nástrojem jsou Clarkova a Parkova transformace popsané výše v této kapitole.
 
 
 \chap Popis hardware
 
 \sec Použitý motor
 
 Z široké nabídky bezkartáčových PMS motorů byl vybrán model BLWR233D-36V-4000 od společnosti Aneheim Automation \fnote{Aneheim Automation BLWR23 \url{http://www.anaheimautomation.com/products/brushless/brushless-motor-item.php?sID=148&pt=i&tID=96&cID=22}} viz. Obrázek \ref[motor_obr]. Jedná se o motor s výkonem 92W, pracující při maximálním napětí 36V. Vinutí statoru tvoří 6 polpárů, což znamená, že na každou fázi připadají právě dva. Analogicky má stator motoru právě dva polpáry, viz. Obrázek \ref[pole_pairs].
 
\medskip \clabel[motor_obr]{Použitý motor}
\picw=8cm \cinspic motor.png
\caption/f Použitý motor 
\medskip  
 
  V motoru jsou integrovány Hallovy sondy, které snímají absolutní polohu motoru ve 12 úsecích mechanického plného kruhu. Při přechodu mezi dvěma úseky se mění práve jeden z výstupních signálů těchto senzorů. V místech přechodu je tedy možné určit pozici motoru velmi přesně.
  
   Do motoru je přivedeno celkem 8 vodičů ve dvou svazcích. Ve svazku o třech vodičích jsou přivedeny fáze, v ostatních je pak napájení a výstup hallových senzorů, viz. Tabulka \ref[Vodice_tab]. V Tabulce \ref[Motor_tab] jsou pak uvedeny technické parametry motoru.

 \medskip \clabel[Motor_tab]{Parametry použitého motoru}
\ctable{lll}{ 
	\hfil Veličina & Uvedené hodnoty / jednotky & Metrický systém  \crl
		Max. napětí & 36 V & 36 V  \cr
		Max. výkon & 92 W & 92 W  \cr
		Max. točivý moment & 31.2 oz-in & 0.0219 Nm  \cr
		Max. otáčky & 4000 rpm & 4000 rpm   \cr
		Torque constant & 8.5 oz-in/A & 0.06 Nm/A  \cr
		BEMF konst. & 4.45 V/krpm  & 4.45 V/krpm   \cr
		Odpor mezi fázemi (line-to-line)& 0.64 $\Omega$ & 0.64 $\Omega$   \cr
		Vzájemná indukčnost fází & 2.1 mH & 2.1 mH    \cr
		Moment setrvačnosti rotoru & 0.00106 oz-in-$sec^2$ & $7.485*10^{-6}$ kg$*m^2$  \cr
		Délka & 2.9 in & 73.7 mm   \cr
		Váha & 1.65 lbs & 0.75 kg  \cr	
}
\caption/t Parametry použitého motoru 
\medskip

 \medskip \clabel[Vodice_tab]{Vodiče přivedené do motoru}
\ctable{lll}{ 
	\hfil Svazek & Barva & Funkce  \crl
		1 & Žlutá & Fáze A  \cr
		1 & Červená & Fáze B  \cr
		1 & Černá & Fáze C  \cr
		2 & Červená & Napájení hallů  \cr
		2 & Modrá & Hall senzor A  \cr
		2 & Zelená & Hall senzor B  \cr
		2 & Bílá & Hall senzor C  \cr
		2 & Černá & Uzemění hallů  \cr
}
\caption/t Vodiče přivedené do motoru 
\medskip 
  
  K motoru je též z jedné strany namontován inkrementální rotační čítač (dále jen \glref{IRC}), který měří relativní polohu polohu motoru vůči pozici při startu řízení. Jeho výhodou je vysoká přesnost.  Zatímco Hallovy sondy dokáží rozlišit jen mezi 12 polohami na jednu mechanickou otáčku, IRC rozezná 2000 samostatných bodů. K IRC vedou vodiče napájení a signálů s daty o poloze. Dva z nich jsou signály, které ze svých aktuálních stavů a jejich změn poskytují informaci o pohybu motoru a jeho směru. Třetí signál pak vyšle puls vždy jen v jedné pozici za jednu mechanickou otáčku motoru. Poskytuje tak absolutní polohu.
  
 

 
 \label[sec_rpi]
 \sec Raspberry Pi
 
 Raspberry Pi je jednodeskový počítač založený na rodině architektury ARM, který se v současnosti dodavá v několika variantách.
 
 Základem první verze tohoto minipočítače je \glref{SoC} BCM2835, který obsahuje centrální procesor ARM1176JZF-S s taktem 700 MHz, grafický procesor VideoCore IV a 256 MB nebo 512 MB  paměti RAM. Neumožňuje však připojení pevného disku. Opearační systém a data, která mají být uchována i po restartu zařízení je třeba uložit na SD kartu, jejíž slot je k dispozici. Protože procesorová jednotka typu ARM11 využíva poměrně zastaralou architekturu ARMv6 s nedostatečnou hardwarovou podporou pro výpočty v polovoucí řádové čárce  \glref{VFP}v2 \cite[ARM11] \fnote{ARM11 Online Technical Reference Manual \url{http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0301h/Cegdejjh.html}}, je nutná rekompilace distribuce systému Debian/Raspbian. Oficiální port této distribuce ARMhf totiž vyžaduje alespoň architektutu ARMv7 s koprocesorem pro výpočty v plovoucí řádové čárce nejméně ve verzi VFPv3-D16. \fnote{Debian, List of official ports \url{https://www.debian.org/ports/}}
 
\midinsert \clabel[RPiB+]{Raspberry Pi v1 model B+}
\picw=8cm \cinspic Raspberry_Pi_B+_top.png
\caption/f Raspberry Pi verze 1 model B+
\endinsert 
 
Druhá verze Raspberry Pi přinesla zvýšení výpočetního výkonu s růstem taktu procesoru na 900Mhz a využitím čtyř výpočetních jader. To vše pod modernější architekturou ARMv7-A s procesorem ARM Cortex-A7 (podpora \glref{VFP}v4 \cite[CA_VFP] \fnote{ARM Cortex-A7 Online Technical Reference Manual \url{http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.subset.cortexa.cortexa7/index.html}}) v čipu BCM2836. Tato verze počítače je tak se současnými distribucemi plně kompatibilní. Kromě vyššího výpočetního výkonu došlo i k nárustu hlavní paměti na 1GB. Momentálně je k dispozici jen v modelu B, který navazuje na model B+ verze 1. Na rozdíly jednotlivých variant odkazuje tabulka \ref[RPi_Modely]

Nevýhodou použitých SoC v obou verzích je chybějící integrovaná podpora rozhraní ethernet. Pro připojení do sítě toho typu je použit na desku integrovaný převodník USB-Ethernet.  

%clabel prida referenci - muzu odkazovat \ref + prida do seznamu tabulek / obrazku
%midinsert, topinsert - chce na zacatek stranky, kdyz to nejde, prejde na zacatek dalsi
\midinsert \clabel[RPi_Modely]{Seznam modelů Raspberry Pi}
\ctable{lccccc}{ 
	\hfil Model & A & A+ & B & B+ & Bv2 \crl
		Počet pinů & 26 & 40 & 26 & 40 & 40  \cr
		RAM paměť [MB]  & 256 & 256 & 256/512 & 512 & 1024   \cr
		USB porty & 1 & 1 & 2 & 4  & 4 \cr
		RJ45 & Ne & Ne & Ano & Ano  & Ano \cr
		Slot na kartu & SDHC & MicroSD & SD & MicroSD & MicroSD   \cr
		Příkon [W] & 1.5 & 1.0 & 3.5 & 3 & 4  \cr
		Takt CPU [MHz] & 700 & 700 & 700 & 700 & 900  \cr
		Jádra CPU [MHz] & 1 & 1 & 1 & 1 & 4  \cr
		CPU Arch [W] & ARMv6 & ARMv6 & ARMv6 & ARMv6 & ARMv7-A  \cr
}
\caption/t Seznam modelů Raspberry Pi 
\endinsert


 \label[sec_rt]
 \sec Linux a RT vylepšení
 
 Linux je víceuživatelský, víceúhlový operační systém založený na stejnojmenném jádře, které vyvinul v roce 1991 Linus Thorvadls. S vylepšením zaručující maximální čas odezvy na vnější události se stává zajímavou volbou i pro některé řídicí aplikace.
 
 Systém, který byl původně myšlen spíše jako koníček se postupem času vyvinul z pouhého emulátoru terminálu v jeden z nejpoužívanějších na světě. Dnes mají Linuxové distribuce 97\% zastoupení mezi největšími superpočítači \fnote{Linux dominates supercomputers \url{http://www.zdnet.com/article/linux-dominates-supercomputers-as-never-before}} a například systém Android, s Linuxovým jádrem, běží na 47\% všech smartphonů a tabletů \fnote{Mobile/Tablet Operating System Market Share \url{http://marketshare.hitslink.com/operating-system-market-share.aspx?qprid=8&qptimeframe=M&qpcustomd=1}}. Mohutný rozmach systému byl zapříčiněn mimo jiné zveřejněním jeho zdrojového kódu pod svobodnou licencí. To umožnilo na jeho vývoji pracovat tisícům dobrovolníků a mnoha korporacím, mezi které patří například Red Head, Intel, Samsung či Google \fnote{Who actually develops Linux? \url{http://www.extremetech.com/computing/175919-who-actually-develops-linux-the-answer-might-surprise-you}}.
 
 
 Pro široké možnosti svého využití a jednoduché vzdálené správy si systém brzy získal oblibu mezi vyvojáři. Doménou řídicích aplikací však dále zůstavaly menší systémy. Linux se tak stával součástí jen větších celků, kde za odezvu k kritických částech byl zodpovědný \glref{RT} OS a Linux plnil spíše administrativní funkce. Vývoj plikací pro menší RT OS však přinaší mnoho komplikací navíc, přikladem je spíše minimalistické \glref{API} a často nedostatečná podpora některých komunikačních protokolů. Vznikl tak projekt, jehož cílem bylo upravit linuxové jadro způsobem, který umožní včasné přeplánování a zajistí tak splnění časových požadavků vyžadovaných řízením. 
 
 Projekt KURT (Kansas University Real Time) se stal průkopníkem, když využil podporu Linuxu pro víceprocesorové systémy (\glref{SMP}) a rozšířil možnost souběhu procesů při zpracování systémových volání v jádře, což jádro dříve v plné míře nedovolovalo. Serializace takových úseků, ve kterých se v danou chvíli směl nacházet jen jeden procesor je pak řešena zámky s aktivním čekáním (spin-lock). Ostatní úseky kódu s nutností vyloučení vzájemného  souběhu namísto spin-locků začaly využívat RT-mutex. Další snaha byla minimalizovat či přepracovat části kódu, které neumnožňují preempci, jako například obslužné rutiny přerušení. Důležitá je implementace dědění priorit.  \cite[preemption] \cite[rychlost_odezvy] 
 
 Vzhledem k rozsáhlosti zdrojového kódu systému Linux není možné analyticky spočítat veškerá spoždění. Podobný výpočet by navíc nebyl možný při použití rozmanitých vyrovnávacích pamětí a víceprocesorových systémů. Pro mnoho aplikací je však dostačující znát průběhy zpoždění měřeného na zatíženém systému v delším časovém období - řádově v měsících. Těmito testy a také dalším vývojem RT vlastností Linuxu se zabývá laboratoř OSADL \fnote{OSADL \url{http://www.osadl.org/}}. 
 
 Jedna z posledních verzí RT-varianty jádra (3.18.7-rt2), tak po měsících testování reakcí na vnější události nevykázala byť jediné zpoždění přesahující 100$\mu$s. Přičemž testy probíhaly  na výkonném HW s architekturou x86. Pro některé další architektury, napřiklad ARM pak zpožnějí pro vybrané modely nepřesahuje 200$\mu$s. \cite[rychlost_odezvy].
 
 \secc Aplikace RT patche
 
 \cite[rt-wiki]

 
 
  
 \label[sec_fpga] 
 \sec FPGA obvod 
 
FPGA obvody (Field Programmable Gate Array - Programovatelná hradlová pole) jsou speciální číslicové integrované obvody obsahující různě složité programovatelné bloky, dále násobičky či různé druhy pamětí. Tyto bloky jsou propojené konfigurovatelnou maticí spojů. FPGA obvody se odlišují od naprosté většiny integrovaných obvodů možností přeprogramování - při změně požadavků lze jednoduše náhrát novou konfiguraci propojovací matice.

FPGA se v současnosti využívají v mnoha aplikacích. Těží tak svých vlastností, mezi které patří poměrně snadný návrh v některém z HDL jazyků či grafických nástrojů. Flexibilita, neustále klesající cena ale i zmenšující se spotřeba elektrcké energie patří mezi další pozitiva. Běžnou oblastí použití je prototypování složitějších zařízení či tvorba periferií pro procesorové jednotky - tzv. \uv{Glue logic}. Složitější FPGA obvody je dokonce možné použít k implementaci procesoru.\cite[fpga_proc]  \cite[xilinx_fpga] \cite[bart_dis]

Pro tuto práci byl vybrán FPGA obvod firmy Altera z rodiny IGLOO. Konkrétně čip AGL125 v pouzdře VQ100. Tato jednotka obsahuje 125 tisíc hradel a nabízí mimo jiné 36 kbits RAM. Podporuje In System Programming (\glref{ISP}) a lze naprogramovat prostřednictvím rozhraní \glref{JTAG} \cite[AGL125]. Obvod není při připojení napájení inicializován. Není tedy možné inicializovat jeho interní signály a proměnné na zvolené výchozí hodnoty. Výhodným řešením může být využití resetu z bloku fázového závěsu. Bez implementace tohoto mechanismu je ale třeba brát na zřetel hrozbu inicicializace na nevhodné hodnoty. Přikládem jsou signály pro ovládání polovičních H-můstků, které, při inicializaci na logickou jedničku mohou zapříčinit přehřátí a zničení motoru.  

Návrh byl vytvořen v HDL jazyce VHDL. Jazyk VHLD slouží jak k popisu a následné syntéze obvodu v programovatelném hradlovém poli, tak k simulacím. Používá se také pro popis obvodů, které se podle návrhu ve VHDL později přímo vyrobí.  Standardizován byl v r. 1987. Jako jazyk vyvinutý z přísně typového jazyka Ada si pak ponechává některé jeho vlastnosti, které se s výhodou využijí při popisu hardware. Výhodou jazyka Ada, tedy i VHDL, je zabudovaná možnost souběžného výkonávání kódu. Tato funkce se totiž plně využije právě při navrhování hardware, kde je souběžné vykonávání elementární záležitostí. Vznikají tak bloky {\em Process}, které po příchodu spouštěcího signálu pracují zcela paralelně. 

\sec Syntéza VHDL kódu a programování FPGA

Pro syntézu kódu jsem použil balíček aplikací {\em Libero} viz. Manuál \cite[Libero_ug] vyvíjený společností {\em Microsemi Corporation} \fnote{Microsemi Corporation \url{http://www.microsemi.com/}}. Program je možné používat i zdrama. Jedinou podmínkou je registrace a získání \uv{FREE Licence}. Před každým spuštěním aplikace pak musí běžet licenční daemon. Jeho spouštěcí příkaz je následující:
\begtt
/opt/microsemi/licensing_daemon/lmgrd ...
-c /opt/microsemi/license/license.dat ...
-l /home/user/license.log
\endtt

Samotná syntéza se pak provede spuštěním skriptu "synthetize-agl.sh". Tento skript volá program "synplify_pro", který je součástí balíčku staženého s aplikací Libero. Všechny soubory VHDL, včetně nejvyšší entity, musí být uvedené v souboru "syn.tcl" a při syntéze musí být umístěné v spolu se skriptem v jednom adresáři.

Pro naprogramování FPGA obvodu je využívána open-source aplikace  {\em UrJTAG} hostovaná na serveru {\em Sourceforge} \fnote{UrJTAG, Sourceforge.net \url{http://sourceforge.net/projects/urjtag/}}. Aplikace využívá knihovny "libusb" a "libftdi". Zvláště knihovna "libftdi" může být potenciálním zdrojem potíží, tím spíše, používáme-li 64bitový systém. Po zvládnutí počátečních potíží je možné FPGA obvod naprogramovat spuštěním skriptu "program-agl.sh" ze stejného adresáře, jako proběhla syntéza.

\sec Výkonový hardware

Samotný obvod je integrován do plošného spoje viz. Příloha \ref[priloha_motor]. Napájení o velikosti 3.3V je zajištěno z RPi, které konvertuje napětí 5V přivedené z měniče TEN 6-2411WIN \fnote{Traco Power DC/DC Converters \url{http://mediaserver.voxtechnologies.com/FileCache/Traco\%20Power-TEN\%206WIN\%20Series-datasheet1-1243850956.pdf}}. Bezstrátové řízení motoru pak zajišťuje trojice polovičních H-můstku řady LT1158 \fnote{Half Bridge N-Channel Power MOSFET Driver \url{http://cds.linear.com/docs/en/datasheet/1158fb.pdf}}. Tyto můstky jsou přitom od FPGA galvaniicky odděleny pomocí dvoukanálového číslicového izolátoru ADuM1200 \fnote{ Dual-Channel Digital Isolators \url{http://www.analog.com/media/en/technical-documentation/data-sheets/ADuM1200_1201.pdf}}. Pro vyčítání hodnot ze sensorů proudu je použit 12-bitový AD převodník ADS7841 \fnote{ADS7841 \url{http://www.ti.com/lit/ds/symlink/ads7841.pdf}}. Celý obvod může být napájen v poměrně velkém rozsahu napětí pohybujím se mezi 9V až 36V. Mechanické propojení s Raspberry Pi je realizováno prostřednictvím plochého 26-žilového kabelu viz. Obrázek \ref[propojeni_obr]


\midinsert \clabel[propojeni_obr]{Propojení Raspberry Pi s výkonovým HW}
\picw=10cm \cinspic propojeni.png
\caption/f Propojení Raspberry Pi s výkonovým HW
\endinsert 
 
 
 
 \chap Použité řešení
 
 \sec Komunikační protokol
 
 Výběr komunikačního protoku mezi RPi a FPGA obvodem se stal jednou z prvních otázek a bylo ji třeba zodpovědět již na začátku práce. 
 
 Existuje celá řada známých a hojně využívaných protokolů pro komunikaci ať již mezi periferiemi a procesorovou jednotkou či mezi procesory navzájem. Příkladem je $I^2C$, SSI, USART a jeho synchronní varianta SPI. Požadavky přitom byly jasné. Komunikační protokol musí být dostatečně rychlý, aby při frekvenci minimálně 1kHz dokázal přenést alespoň 128bitů. A to oběma směry.
 
 Protokol $I^2C$ se zdál příliš složitý, vzhledem ke svým módům a zde zbytečné adresaci. Asynchronní verze protokolu USART nemá v tomto případě smysl, protože náš FPGA obvod nemá vnitří zdroj hodinového signálu. Jako příhodné varianty se jeví protokoly SSI a SPI. Výhodou SSI protokolu je, že jím generovaný hodinový signál, posílaný po samostatném vodiči, není zastaven s koncem komunikačního cyklu. Protokol SPI hodinový signál v této chvíli zastavuje a je tedy nutné do FPGA obvodu přivést hodinový signál zcela zvlášť. Tento signál je totiž nutný pro funkci všech synchronních komponent obvodu. Na rozdíl od protokolu SSI je ale SPI integrován (alespoň jeho master varianta) do jádra operačního systému Linux. Není tedy třeba tvořit vlastní ovladač.
 
 \sec Čtení AD převodníků za senzory proudu


\sec Generování PWM a dekódování IRC

\sec Implementace požadavků RT patche v aplikaci 

 \chap Závěr
 

 



 \bibchap
 \usebib/c (simple) mybase

\app Zadání

 \sec pokyny
 
Na platformě procesorové desky Raspberry Pi implementujte systém pro řízení bezkartáčových (BLDC/PMSM) motorů.

1. Pro komunikaci procesorového systému s výkonovým hardwarem realizovaným s využitím programovatelného obvodu (FPGA) vyberte vhodný protokol a periferii.

2. Pro vybraný způsob komunikace navrhněte ovladač na straně jádra Linux a obvodový návrh ve VHDL na straně FPGA.

3. Integrujte bloky pro snímání polohy, řízení výkonových stupňů a měření proudu do FPGA návrhu.

4. S využitím navržených periferií realizujte řízení bezkartáčového motoru.

5. Vyžaduje se podrobná technická dokumentace včetně přípravy podkladů pro prezentaci včetně videozáznamu.

\app Zkratky\par \makeglos %vlozi novou prilohu

\label[priloha_motor]
\app Dokumentace výkonového stupně Rpi-Mi-1, PiKRON 2014


\topinsert 
\picw=16cm \cinspic 3p-motor-driver-1-sch.pdf
\caption/f Schéma driveru motoru
\endinsert 

\topinsert 
\picw=15.8cm \cinspic rpi-mi-1-sch.pdf
\caption/f Schéma propojení RPi a FPGA obvodu
\endinsert  
 
 \bye
  
 